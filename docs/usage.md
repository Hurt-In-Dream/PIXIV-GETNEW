# 使用教程

部署完成后，你可以通过 Web 管理面板控制整个系统的运行。

## 1. 管理面板概览

访问你的部署域名，你将看到以下模块：

### 📊 统计数据栏
显示当前状态、Cron 表达式、标签数和 R-18 状态。

### ⚙️ 爬虫设置

#### Cron 表达式
定时任务触发频率（需要在 `vercel.json` 中同步修改才生效）。

#### 抓取数量设置
- **全年龄抓取数量**: 每次从 `daily` 排行榜抓取的图片数 (5-30张)
- **R-18 抓取数量**: 每次从 `daily_r18` 排行榜抓取的图片数 (需开启 R-18)

#### R-18 开关
- 开启需要输入验证码
- 开启后将同时抓取普通排行榜和 R18 排行榜

#### 标签搜索 (可选)
- 单独开关控制
- 开启后会按指定标签搜索 Pixiv
- 结果存储到独立的 `tag/` 文件夹
- **标签语言**: 使用**日语**最准确

常用标签对照：
| 中文 | 日语 (推荐) |
|------|------------|
| 风景 | 風景 |
| 背景 | 背景 |
| 夜景 | 夜景 |
| 女孩 | 女の子 |
| 原神 | 原神 |
| 碧蓝档案 | ブルーアーカイブ |
| 碧蓝航线 | アズールレーン |

### 🚀 手动抓取
- **功能**: 立即从 Pixiv 排行榜抓取图片
- **自定义**: 通过滑块选择抓取数量
- **智能筛选**: 自动平衡横竖屏比例 (1.5:1)，并过滤不适合的作品

### 🔍 PID 抓取
- **功能**: 输入特定的 Pixiv 作品 ID (PID) 进行抓取
- **相关推荐**: 可同时抓取该作品的相关推荐

### 📋 活动日志
- **数据库持久化**: 日志存储在数据库中，刷新页面不丢失
- **自动刷新**: 每 5 秒自动更新
- **筛选功能**: 可按级别 (信息/成功/警告/错误) 筛选
- **清空功能**: 可一键清空所有日志

### 🏷️ 过滤标签管理
- **表格展示**: 显示所有过滤标签及其翻译
- **分类管理**: 标签按类别分组 (背景、风格、AI、VTuber 等)
- **自定义添加**: 可添加新的过滤标签
- **删除功能**: 可移除不需要的过滤标签

### 🖼️ 图片库
- **浏览**: 查看所有已转存到 R2 的图片
- **R18 过滤**: 首页图库自动隐藏 R18 图片
- **图片显示**: 优先使用 R2 链接，失败时回退到 pixiv.re 镜像
- **管理**: 复制链接、查看原图、删除记录

## 2. 存储逻辑说明

### R2 文件夹结构

```
your-r2-bucket/
├── h/                    # 排行榜横屏 (landscape)
├── v/                    # 排行榜竖屏 (portrait)
├── R18/h/                # R18排行榜横屏
├── R18/v/                # R18排行榜竖屏
├── tag/h/                # 标签搜索横屏
├── tag/v/                # 标签搜索竖屏
├── pid/h/                # PID抓取横屏
├── pid/v/                # PID抓取竖屏
├── R18/tag/h/            # R18标签搜索横屏
└── R18/tag/v/            # R18标签搜索竖屏
```

### 文件命名格式
`日期_PID.扩展名` (例如 `20260101_11451419.jpg`)

### 横竖屏比例
系统自动维持 **1.5:1** 的横竖比例 (60% 横屏, 40% 竖屏)

## 3. 自动抓取流程

每次 Cron 任务触发时：

1. 从 `daily` 排行榜抓取 N 张图片 (N = 全年龄抓取数量)
2. 如果开启 R-18，从 `daily_r18` 排行榜抓取 M 张 (M = R-18 抓取数量)
3. 如果开启标签搜索，随机选择一个标签搜索抓取
4. 对每张图片进行智能筛选 (过滤不适合的标签)
5. 自动平衡横竖屏比例
6. 上传到 R2 对应文件夹
7. 保存元数据到数据库

## 4. 常见问题 (FAQ)

### 为什么抓取失败并显示 401？
`PIXIV_PHPSESSID` 过期了。请按照 [环境变量指南](./env-vars.md) 重新获取。

### 为什么有些图片被跳过了？
系统会跳过：
1. 数据库中已存在的 PID（避免重复）
2. 标签中包含过滤关键词的作品 (可在"过滤标签"面板管理)
3. 为平衡比例而跳过的同方向图片

### 如何作为 API 使用？
直接拼接 R2 域名和路径：
```
https://your-r2.com/h/20260101_12345.jpg  # 普通横屏
https://your-r2.com/tag/v/20260101_12345.jpg  # 标签搜索竖屏
```

### 如何加快 R2 访问速度？
建议使用自定义域名代替 `r2.dev` 公共域名：
1. 在 Cloudflare R2 设置中绑定自定义域名
2. 更新 `R2_PUBLIC_URL` 环境变量
3. 配置缓存规则提升 CDN 命中率
