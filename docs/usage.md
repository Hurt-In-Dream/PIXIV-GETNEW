# 使用教程

部署完成后，你可以通过 Web 管理面板控制整个系统的运行。

## 1. 管理面板概览

访问你的部署域名，你将看到以下模块：

### 📊 统计数据栏
显示当前状态、Cron 表达式、标签数和 R-18 状态。

### ⚙️ 爬虫设置

#### Cron 表达式
定时任务触发频率（需要在 `vercel.json` 中同步修改才生效）。

#### 抓取数量设置
- **全年龄抓取数量**: 每次从 `daily` 排行榜抓取的图片数 (5-30张)
- **R-18 抓取数量**: 每次从 `daily_r18` 排行榜抓取的图片数 (需开启 R-18)

#### R-18 开关
- 开启需要输入验证码
- 开启后将同时抓取普通排行榜和 R18 排行榜

#### 标签搜索 (可选)
- 单独开关控制
- 开启后会按指定标签搜索 Pixiv
- 结果存储到独立的 `tag/` 文件夹
- **标签语言**: 使用**日语**最准确

常用标签对照：
| 中文 | 日语 (推荐) |
|------|------------|
| 风景 | 風景 |
| 背景 | 背景 |
| 夜景 | 夜景 |
| 女孩 | 女の子 |
| 原神 | 原神 |
| 碧蓝档案 | ブルーアーカイブ |
| 碧蓝航线 | アズールレーン |

### 🚀 手动抓取
- **功能**: 立即从 Pixiv 排行榜或标签搜索抓取图片
- **模式切换**: 
  - **排行榜** - 抓取每日排行榜图片
  - **标签搜索** - 使用设置中的标签进行搜索
- **自定义**: 通过滑块选择抓取数量

### 🔍 PID 抓取
- **功能**: 输入特定的 Pixiv 作品 ID (PID) 进行抓取
- **相关推荐**: 可同时抓取该作品的相关推荐

### 🐙 GitHub 同步
将 R2 中的图片同步到 GitHub 仓库，用于随机图片 API。

#### 功能特性
- **一键同步全部**: 自动同步所有分类，直到全部完成
- **单独同步**: 可以单独同步某一个分类
- **批量提交**: 每 50 张图片一次 commit，只触发一次部署
- **循环同步**: 如有 100 张待传，会自动分批上传直到完成
- **进度显示**: 实时显示同步进度

#### 支持的分类
| 分类 | GitHub 目录 | 说明 |
|------|-------------|------|
| 排行榜横屏 | `ri/h/` | 普通排行榜 |
| 排行榜竖屏 | `ri/v/` | 普通排行榜 |
| R18横屏 | `ri/r18/h/` | R18 内容 |
| R18竖屏 | `ri/r18/v/` | R18 内容 |
| PID横屏 | `ri/pid/h/` | PID 抓取 |
| PID竖屏 | `ri/pid/v/` | PID 抓取 |
| 标签横屏 | `ri/tag/h/` | 标签搜索 |
| 标签竖屏 | `ri/tag/v/` | 标签搜索 |

#### 图片处理
- 自动转换为 **WebP 格式**（质量 85%）
- 自动按顺序编号（1.webp, 2.webp...）

### 📋 活动日志
- **数据库持久化**: 日志存储在数据库中，刷新页面不丢失
- **自动刷新**: 每 5 秒自动更新
- **筛选功能**: 可按级别 (信息/成功/警告/错误) 筛选
- **清空功能**: 可一键清空所有日志
- **同步日志**: GitHub 同步进度会显示在活动日志中

### 🏷️ 过滤标签管理
- **表格展示**: 显示所有过滤标签及其翻译
- **分类管理**: 标签按类别分组 (背景、风格、AI、VTuber 等)
- **自定义添加**: 可添加新的过滤标签
- **删除功能**: 可移除不需要的过滤标签

### 🖼️ 图片库
- **浏览**: 查看所有已转存到 R2 的图片
- **来源筛选**: 可按来源筛选 (排行榜/R18/标签/PID/全部)
- **图片显示**: 优先使用 R2 链接，失败时回退到 pixiv.re 镜像
- **管理**: 复制链接、查看原图、删除记录

## 2. 存储逻辑说明

### R2 文件夹结构

```
your-r2-bucket/
├── h/                    # 排行榜横屏 (landscape)
├── v/                    # 排行榜竖屏 (portrait)
├── R18/h/                # R18排行榜横屏
├── R18/v/                # R18排行榜竖屏
├── tag/h/                # 标签搜索横屏
├── tag/v/                # 标签搜索竖屏
├── pid/h/                # PID抓取横屏
├── pid/v/                # PID抓取竖屏
├── R18/tag/h/            # R18标签搜索横屏
└── R18/tag/v/            # R18标签搜索竖屏
```

### GitHub 仓库结构 (随机图片 API)

```
EdgeOne_Function_PicAPI/
├── functions/
│   └── pic.js            # 随机图片 API 逻辑
├── ri/
│   ├── h/                # 横屏图片 (1.webp, 2.webp...)
│   ├── v/                # 竖屏图片
│   ├── r18/h/            # R18 横屏
│   ├── r18/v/            # R18 竖屏
│   ├── pid/h/            # PID 横屏
│   ├── pid/v/            # PID 竖屏
│   ├── tag/h/            # 标签横屏
│   └── tag/v/            # 标签竖屏
└── index.html
```

### 文件命名格式
- **R2**: `日期_PID.扩展名` (例如 `20260101_11451419.jpg`)
- **GitHub**: `序号.webp` (例如 `1.webp`, `2.webp`...)

### 横竖屏比例
系统自动维持 **1.5:1** 的横竖比例 (60% 横屏, 40% 竖屏)

## 3. 自动抓取流程

每次 Cron 任务触发时：

1. 从 `daily` 排行榜抓取 N 张图片 (N = 全年龄抓取数量)
2. 如果开启 R-18，从 `daily_r18` 排行榜抓取 M 张 (M = R-18 抓取数量)
3. 如果开启标签搜索，随机选择一个标签搜索抓取
4. 对每张图片进行智能筛选 (过滤不适合的标签)
5. 自动平衡横竖屏比例
6. 上传到 R2 对应文件夹
7. 保存元数据到数据库

## 4. GitHub 同步 API 使用

同步完成后，可以通过以下方式获取随机图片：

```
https://your-api-domain/pic?img=h     # 随机横屏
https://your-api-domain/pic?img=v     # 随机竖屏
https://your-api-domain/pic?img=ua    # 根据设备自适应
https://your-api-domain/pic?img=r18h  # R18 横屏
https://your-api-domain/pic?img=r18v  # R18 竖屏
https://your-api-domain/pic?img=r18ua # R18 自适应
```

图片数量实时从 GitHub 读取，无需手动更新配置。

## 5. 常见问题 (FAQ)

### 为什么抓取失败并显示 401？
`PIXIV_PHPSESSID` 过期了。请按照 [环境变量指南](./env-vars.md) 重新获取。

### 为什么有些图片被跳过了？
系统会跳过：
1. 数据库中已存在的 PID（避免重复）
2. 标签中包含过滤关键词的作品 (可在"过滤标签"面板管理)
3. 为平衡比例而跳过的同方向图片

### GitHub 同步失败怎么办？
1. 检查 `GITHUB_TOKEN` 环境变量是否配置
2. 检查 Token 是否有 `repo` 权限
3. 检查 Token 是否过期

### 如何加快 R2 访问速度？
建议使用自定义域名代替 `r2.dev` 公共域名：
1. 在 Cloudflare R2 设置中绑定自定义域名
2. 更新 `R2_PUBLIC_URL` 环境变量
3. 配置缓存规则提升 CDN 命中率
