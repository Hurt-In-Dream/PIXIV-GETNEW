# 使用教程

部署完成后，你可以通过 Web 管理面板控制整个系统的运行。

## 1. 管理面板概览

访问你的部署域名，你将看到以下模块：

### 📊 统计数据栏
显示当前状态、Cron 表达式、标签数和 R-18 状态。

### ⚙️ 爬虫设置

#### Cron 表达式
定时任务触发频率（需要在 `vercel.json` 中同步修改才生效）。

#### 抓取数量设置
- **全年龄抓取数量**: 每次从 `daily` 排行榜抓取的图片数 (5-30张)
- **R-18 抓取数量**: 每次从 `daily_r18` 排行榜抓取的图片数 (需开启 R-18)

#### R-18 开关
- 开启需要输入验证码
- 开启后将同时抓取普通排行榜和 R18 排行榜

#### 标签搜索 (可选)
- 单独开关控制
- 开启后会按指定标签搜索 Pixiv
- 结果存储到独立的 `tag/` 文件夹
- **标签语言**: 使用**日语**最准确

常用标签对照：
| 中文 | 日语 (推荐) |
|------|------------|
| 风景 | 風景 |
| 背景 | 背景 |
| 夜景 | 夜景 |
| 女孩 | 女の子 |
| 原神 | 原神 |
| 碧蓝档案 | ブルーアーカイブ |
| 碧蓝航线 | アズールレーン |

### 🚀 手动抓取
- **功能**: 立即从 Pixiv 排行榜或标签搜索抓取图片
- **模式切换**: 
  - **排行榜** - 抓取每日排行榜图片
  - **标签搜索** - 使用设置中的标签进行搜索
- **自定义**: 通过滑块选择抓取数量

### 🔍 PID 抓取
- **功能**: 输入特定的 Pixiv 作品 ID (PID) 进行抓取
- **相关推荐**: 可同时抓取该作品的相关推荐

### 🐙 GitHub 同步
将 R2 中的图片同步到 GitHub 仓库，用于随机图片 API。

#### 功能特性
- **一键同步全部**: 自动同步所有分类，直到全部完成
- **单独同步**: 可以单独同步某一个分类
- **批量提交**: 每 50 张图片一次 commit，只触发一次部署
- **循环同步**: 如有 100 张待传，会自动分批上传直到完成
- **进度显示**: 实时显示同步进度

#### 支持的分类
| 分类 | GitHub 目录 | 说明 |
|------|-------------|------|
| 排行榜横屏 | `ri/h/` | 普通排行榜 |
| 排行榜竖屏 | `ri/v/` | 普通排行榜 |
| R18横屏 | `ri/r18/h/` | R18 内容 |
| R18竖屏 | `ri/r18/v/` | R18 内容 |
| PID横屏 | `ri/pid/h/` | PID 抓取 |
| PID竖屏 | `ri/pid/v/` | PID 抓取 |
| 标签横屏 | `ri/tag/h/` | 标签搜索 |
| 标签竖屏 | `ri/tag/v/` | 标签搜索 |

#### 图片处理
- 自动转换为 **WebP 格式**（质量 85%）
- 自动按顺序编号（1.webp, 2.webp...）

### 📋 活动日志
- **数据库持久化**: 日志存储在数据库中，刷新页面不丢失
- **自动刷新**: 每 5 秒自动更新
- **筛选功能**: 可按级别 (信息/成功/警告/错误) 筛选
- **清空功能**: 可一键清空所有日志
- **同步日志**: GitHub 同步进度会显示在活动日志中

### 🏷️ 过滤标签管理
- **表格展示**: 显示所有过滤标签及其翻译
- **分类管理**: 标签按类别分组 (背景、风格、AI、VTuber 等)
- **自定义添加**: 可添加新的过滤标签
- **删除功能**: 可移除不需要的过滤标签

### 🖼️ 图片库
- **浏览**: 查看所有已转存到 R2 的图片
- **来源筛选**: 可按来源筛选 (排行榜/R18/标签/PID/全部)
- **图片显示**: 优先使用 R2 链接，失败时回退到 pixiv.re 镜像
- **管理**: 复制链接、查看原图、删除记录

## 2. 存储逻辑说明

### R2 文件夹结构

```
your-r2-bucket/
├── h/                    # 排行榜横屏 (landscape)
├── v/                    # 排行榜竖屏 (portrait)
├── R18/h/                # R18排行榜横屏
├── R18/v/                # R18排行榜竖屏
├── tag/h/                # 标签搜索横屏
├── tag/v/                # 标签搜索竖屏
├── pid/h/                # PID抓取横屏
├── pid/v/                # PID抓取竖屏
├── R18/tag/h/            # R18标签搜索横屏
└── R18/tag/v/            # R18标签搜索竖屏
```

### GitHub 仓库结构 (随机图片 API)

```
EdgeOne_Function_PicAPI/
├── functions/
│   └── pic.js            # 随机图片 API 逻辑
├── ri/
│   ├── h/                # 横屏图片 (1.webp, 2.webp...)
│   ├── v/                # 竖屏图片
│   ├── r18/h/            # R18 横屏
│   ├── r18/v/            # R18 竖屏
│   ├── pid/h/            # PID 横屏
│   ├── pid/v/            # PID 竖屏
│   ├── tag/h/            # 标签横屏
│   └── tag/v/            # 标签竖屏
└── index.html
```

### 文件命名格式
- **R2**: `日期_PID.扩展名` (例如 `20260101_11451419.jpg`)
- **GitHub**: `序号.webp` (例如 `1.webp`, `2.webp`...)

### 横竖屏比例
系统自动维持 **1.5:1** 的横竖比例 (60% 横屏, 40% 竖屏)

## 3. 自动抓取流程

每次 Cron 任务触发时：

1. 从 `daily` 排行榜抓取 N 张图片 (N = 全年龄抓取数量)
2. 如果开启 R-18，从 `daily_r18` 排行榜抓取 M 张 (M = R-18 抓取数量)
3. 如果开启标签搜索，随机选择一个标签搜索抓取
4. 对每张图片进行智能筛选 (过滤不适合的标签)
5. 自动平衡横竖屏比例
6. 上传到 R2 对应文件夹
7. 保存元数据到数据库

## 4. 随机图片 API

同步完成后，可以通过以下方式获取随机图片：

### 基础用法
```
https://your-api-domain/pic?img=参数
```

### 参数列表

#### 普通图片
| 参数 | 说明 |
|------|------|
| `?img=h` | 横屏随机 |
| `?img=v` | 竖屏随机 |
| `?img=ua` | 设备自适应 |

#### 标签搜索
| 参数 | 说明 |
|------|------|
| `?img=tagh` | 标签横屏随机 |
| `?img=tagv` | 标签竖屏随机 |
| `?img=tagua` | 标签自适应 |

#### PID 抓取
| 参数 | 说明 |
|------|------|
| `?img=pidh` | PID横屏随机 |
| `?img=pidv` | PID竖屏随机 |
| `?img=pidua` | PID自适应 |

#### 全部随机 (普通+标签+PID)
| 参数 | 说明 |
|------|------|
| `?img=allh` | 所有横屏随机 |
| `?img=allv` | 所有竖屏随机 |
| `?img=allua` | 所有图片自适应 |

#### R18 图片
| 参数 | 说明 |
|------|------|
| `?img=r18h` | R18 横屏 |
| `?img=r18v` | R18 竖屏 |
| `?img=r18ua` | R18 自适应 |

#### 全部包含 R18
| 参数 | 说明 |
|------|------|
| `?img=allr18h` | 全部横屏含R18 |
| `?img=allr18v` | 全部竖屏含R18 |
| `?img=allr18ua` | 全部自适应含R18 |

图片数量实时从 GitHub 读取，每 5 分钟更新一次。

## 5. 智能抓取系统

### 喜欢标签功能
在图库中点击图片的 ❤️ 按钮，可以选择喜欢的标签。系统会：
1. 将标签保存到喜欢列表，并记录权重
2. 每次喜欢同一标签，权重 +1
3. 自动抓取时会根据权重优先抓取喜欢的标签
4. 权重越高，抓取数量越多

### 自动抓取流程
每次 Cron 任务触发时：

1. 从 `daily` 排行榜抓取 N 张图片
2. 如果开启 R-18，从 `daily_r18` 排行榜抓取
3. 如果开启标签搜索，随机选择配置的标签抓取
4. **智能抓取**: 根据喜欢标签的权重选择 2 个标签抓取
5. 对每张图片进行过滤 (跳过不适合的标签)
6. 自动平衡横竖屏比例
7. 上传到 R2 对应文件夹
8. 保存元数据到数据库
9. **发送通知**: 如果配置了企业微信 Webhook，发送抓取报告

## 6. 企业微信 Webhook 通知

### 功能说明
系统支持在**所有抓取操作**的开始和完成时发送通知到企业微信群：

| 抓取类型 | 开始通知 | 完成通知 | 错误通知 |
|---------|---------|---------|---------|
| 自动定时抓取 | ✅ | ✅ | ✅ |
| 手动抓取 | ✅ | ✅ | ✅ |
| PID 抓取 | ✅ | ✅ | ✅ |
| 标签搜索 | ✅ | ✅ | ✅ |

### 配置方法
1. 在企业微信群聊中添加机器人
2. 复制机器人的 Webhook URL
3. 在 Vercel 环境变量中添加：
   ```
   WECOM_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY
   ```

### 通知样式预览

#### 开始通知
```
🚀 开始手动抓取
> 🎯 目标 10 张 | 🔞 R18
> 📅 01/09 09:00
```

#### 完成通知
```
🖼️ 手动抓取完成 ✅ 成功
> ✨ +8 新增 | ⏭ 2 跳过 | ⏱ 45.6秒
```

#### 自动抓取报告
```
🖼️ Pixiv 自动抓取报告
✅ 抓取成功

> ✨ 新增 15 张 | ⏭ 跳过 3
> ⏱ 耗时 1分23秒 | 📅 01/09 08:00

📊排行榜: 8 | 🔞R18: 4 | 🧠智能: 3

🏷️ `風景` `女の子` `原神`
```

#### 错误通知
```
❌ 抓取异常 - 自动抓取
> PIXIV_PHPSESSID 已过期
> 📅 01/09 08:01
```

### 测试通知推送
系统同时支持企业微信 Webhook 和 Qmsg酱 QQ 推送。

**测试所有渠道：**
```
https://你的域名/api/webhook-test?type=debug
```

**仅测试 Qmsg酱：**
```
https://你的域名/api/webhook-test?type=qmsg
```

**测试报告格式：**
```
https://你的域名/api/webhook-test?type=report
```

## 7. 智能筛选系统

### 热度筛选 (PID 相关推荐)
针对 PID 抓取的相关推荐，系统使用热度算法过滤低质量图片：

```
热度 = (点赞数 + 收藏数 × 2) / max(浏览量, 5000)
```

| 参数 | 说明 |
|------|------|
| 收藏权重 ×2 | 收藏比点赞更有价值 |
| 浏览量最小 5000 | 避免新作品热度虚高 |
| 最低阈值 0.03 | 低于此值的图片进入备选池 |

**两轮筛选机制**：
1. 先用严格标准筛选（包含热度）
2. 如果结果不够，从"备选池"补充（热度不够但其他条件通过的图片）
3. 确保总能抓取到目标数量的图片

**示例**:
| 图片 | 点赞 | 收藏 | 浏览 | 热度 | 结果 |
|------|------|------|------|------|------|
| 高质量 | 5000 | 3000 | 50000 | 0.22 | ✅ 优先 |
| 低热度 | 50 | 20 | 5000 | 0.018 | 📋 备选 |

### 热度筛选设置
在设置面板中可以选择哪些抓取模式启用热度筛选：
- ☐ 自动抓取 (Cron)
- ☐ 手动抓取
- ☑ PID 相关推荐 (默认开启)

### 比例筛选
系统自动跳过不适合做壁纸的正方形/近似正方形图片：

| 宽高比 | 处理 |
|--------|------|
| < 0.85 (竖屏) | ✅ 抓取 |
| 0.85 ~ 1.18 | ❌ 跳过 (近似正方形) |
| > 1.18 (横屏) | ✅ 抓取 |

### 分辨率筛选
自动跳过低分辨率图片 (宽 < 1200 且 高 < 1200)


## 8. 常见问题 (FAQ)

### 为什么抓取失败并显示 401？
`PIXIV_PHPSESSID` 过期了。请按照 [环境变量指南](./env-vars.md) 重新获取。

### 为什么有些图片被跳过了？
系统会跳过：
1. 数据库中已存在的 PID（避免重复）
2. 标签中包含过滤关键词的作品
3. 正方形或近似正方形比例 (0.85~1.18)
4. 分辨率太低的图片 (宽高都小于 1200px)
5. PID 推荐中热度太低的图片 (低于 0.03)

### 手动抓取超时怎么办？
Vercel 免费版超时限制 10 秒，Pro 版 60 秒。建议：
- 手动抓取设为 **8-10 张**
- 大量抓取使用 **Cron 自动抓取** (300 秒超时)

### GitHub 同步失败怎么办？
1. 检查 `GITHUB_TOKEN` 环境变量是否配置
2. 检查 Token 是否有 `repo` 权限
3. 检查 Token 是否过期

### 图库加载很慢怎么办？
1. 建议使用自定义域名代替 `r2.dev` 公共域名
2. 在 Cloudflare R2 设置中绑定自定义域名
3. 图片会自动尝试多个镜像源 (R2 → i.yuki.sh → pixiv.re)

### 删除图片后 R2 还有怎么办？
新版本已修复此问题。删除图片时会同时从 R2 删除文件。
对于历史遗留文件，可使用清理工具或在 Cloudflare R2 控制台删除。

### 随机 API 总是返回相同图片？
已修复此问题。新版本使用 crypto.getRandomValues() 生成真随机数。
请确保已部署最新版本的 EdgeOne_Function_PicAPI。

## 9. 界面自定义

### 背景图片
系统支持自定义管理面板的背景图片，在 Vercel 环境变量中添加：

```env
NEXT_PUBLIC_BACKGROUND_URL=https://pic.wzkws116.xyz/pic?img=ua
```

效果：
- 图片会自适应全屏显示
- 自动添加高斯模糊效果（8px）
- 自动添加暗色遮罩（保证内容可读）
- 如果不设置此变量，使用纯色背景

### 图库每页显示数量
在图库模块可以选择每页显示的图片数量：
- 支持 12 / 24 / 36 / 48 张
- 默认 12 张

### GitHub 同步进度条
一键同步时会显示实时进度条：
- 显示当前正在同步的分类
- 显示已处理 / 总数
- 显示百分比进度
